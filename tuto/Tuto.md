# StegoBox 

Ce projet présente comment utiliser les méthodes de programmations embarquée pour créer une clef usb bootable contenant un OS minimal ainsi qu'une application web permettant de faire de la stéganographie. En suivant se tutoriel vous pourrez mettre en place ce système qui, en démarrant, affichera une adresse ip sur laquelle se connecter pour acceder à l'application de stéganographie. 

Ce tutoriel utilise debian, quemu pour mettre en place le système, nginx pour le server, et html, css, php et bash pour l'application web. 

La démonstration s'appuie sur le réseau de la salle de réseau de l'université Claude Bernard Lyon 1, pour obtenir une démonstratin similaire sur une configuration differente, il sera peut-être necessaire d'ajuster la mise en place, mais ne vous inquietez pas, ne détaillerons toutes les étapes necessaires ! 

## Preparation de la clef usb

Tout d'abord il faut vous installer les paquets necessaires sur votre ordinateur : 


passez root:
			su

effectuez les mise-à-jour:
			apt-get update

installez debootstrap:
> apt-get install debootstrap

installez qemu:
> apt-get install qemu

creer un rep de travail:
> mkdir work

aller dans le rep de travail:
> cd work

inserez une cle usb et trouvez sa partition:
> fdisk -l

formatez la cle:
> mkfs.ext4 /dev/sdb1

creer un point de montage pour la cle:
> mkdir fs

montez la partition:
> mount /dev/sdb1 fs

lancez debootstrap et telechargez une image debian:
> debootstrap --arch amd64 jessie fs http://ftp.fr.debian.org/debian

lier le dossier /proc:
> mount -t proc none fs/proc

lier le dossier /dev:
> mount -o bind /dev fs/dev

passez en mode chroot:
> chroot fs

creez un mot de passe root (moi):
> passwd

effectuez les mise-à-jour:
> apt-get update

installez un noyau:
> apt-get install linux-image-amd64

recuperez l'UUID de la clé USB:
> blkid
(c0b524f4-5c21-423f-b124-00991a5c50a2)

editez le fichier /etc/fstab:
> vim.tiny /etc/fstab

ajoutez les lignes suivantes a ce fichier:
> proc /proc proc defaults
> UUID=xxxxxxxxxxxxx / ext4 errors=remount-ro 0 1

editez le fichier hostname:
> echo "debian-usb" > /etc/hostname
le fichier ne doit contenir qu'une seul ligne avec ecrit "debian-usb"

editez le fichier network/interfaces:
> vim.tiny /etc/network/interfaces

commantez toutes les lignes et ajoutez les lignes suivantes:
> auto lo
> iface lo inet loopback
> 
> allow-hotplug eth0
> auto eth0
> iface eth0 inet dhcp

installez un clavier azerty:
> apt-get install console-data

installez grub:
> apt-get install grub2

quittez le chroot:
> exit

demontez le dev:
> umount fs/dev

demontez le proc:
> umount fs/proc

demontez la cle:
> umount fs

testez avec qemu:
> qemu-system-x86_64 /dev/sdb

connectez vous en tant que root sur qemu:
> root
> moi

assurez vous d'etre dans home:
> cd

editez le fichier .bashrc:
> vim.tiny .bashrc

(dans la salle info)
ajouter ces lignes à la suite de .bashrc:
> expor http_proxy="http://10.250.100.2:3128"
> expor https_proxy="http://10.250.100.2:3128"

quitez qemu:
> shutdown -h now

relancez qemu avec une redirection de port:
> qemu-system-x86_64 /dev/sdb -redir tcp:8080::80

connectez vous en tant que root sur qemu:
> root
> moi

faire les mise-à-jour:
> apt-get update

installez nginx:
> apt-get install nginx

installez php:
> apt-get install php5-fpm

installez git:
> apt-get install git

installez steghide:
> apt-get install steghide

verifiez que nginx fonctione, sur la machine hote ouvrez un navigateur et tapez localhost:8080, une page 

allez dans le dossier html de nginx:
> cd /var/www/html

supprimez les fichiers qui s'y trouve:
> rm *

clonez le repo git du projet:
> git clone https://github.com/GuiMarion/StegoBox.git

deplacez tout les fichiers dans /var/www/html:
> cd StegoBox
> mv * ..
> cd ..

configurer php pour nginx:
> vim.tiny /etc/nginx/sites-available/default

le fichier doit ressembler exactement au fichier ci-dessous
///////////////////////
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
	#
        location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	#
	#	# With php5-cgi alone:
	#	fastcgi_pass 127.0.0.1:9000;
	#	# With php5-fpm:
		fastcgi_pass unix:/var/run/php5-fpm.sock;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	location ~ /\.ht {
		deny all;
	}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}
///////////////////////

ensuite relancez nginx:
> service nginx restart

puis sur la machine hote raffrechissez la page localhost:8080,
le site Stego box devrait s'afficher correctement

vous pouvez maintenant ajouter des images sur la page Upload
(seul le format jpg est accepté)

après avoir ajouter une image vous pouvez cacher un message dans cell-ci grace à la page Append

puis vous pouvez extraire ce message avec la page Extract

enfin vous pouvez afficher les image sur la page View

quand vous avez finis de tester eteindre qemu:
> shutdown -h now

---------------------------------------------------

Vous pouvez maintenant utiliser votre clé sans qemu:

bootez sur la clez (f12)

obtenir une addresse ipv4
> dhclient -4

veriffier l'adresse (10.250.100.XXX)(A)
> ifconfig

demarrez une autre machine
refuser le login
veriffier l'adresse de l'autre machine (10.250.100.XXX)
> ifconfig
ouvrir un navigateur
entrez l'adresse ip (A) dans la barre du navigateur

Pour Afficher l’ip au démarrage : 

Rediriger l’affichage du script (script sur le git) sur /dev/tty1

Echo ip >> /dev/tty1

Faire en sorte que le script se lance au démarage et s’actualise : 

		crontab -e 

Et ajouter à la fin du fichier 

@reboot path_to_script
* * * * * path_to_script

Cela permet de lancer le script au démarrage ainsi que toutes les minutes (au cas où l’adresse ip change)

Il faut maintenant désactiver le service getty@tty1 afin que le système lance les services (nginx par exemple), affiche l’adresse ip ne demande pas de se connecter. 



-----------------------------------------------------

Limite : 

Nous avons creer un script pour afficher l'address IP de la machine, ce script s'appelle Start.sh et il est situé dans le repo git, et donc dans /var/www/html.
Cependant il  n'execute pas au demarage, nous pourrions donc l'executer automatiquement grace à autologin de cette façon nous seron également logé automatiquement.

De plus notre projet est vulnérable au injection de commande shell, ce qui est extremement dangeureux d'autant plus que s'execute en tant que root ! Pour remedier à cela nous aurions put essayer de bloquer les injection dans le php et également a voir une gestion plus fine des permission utilisateurs, comme en executant nos script en tant que www/data par exemple.

